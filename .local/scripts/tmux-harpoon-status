#!/usr/bin/env bash

file="${XDG_CACHE_HOME:-$HOME/.cache}/tmux-harpoon"
[ ! -f "$file" ] && exit 0

# Get current session path
current_path=$(tmux display-message -p '#{session_path}' 2>/dev/null)

# Colors (matching dragon theme)
normal_bg="#737C73"
highlight_bg="#c4b28a"

# Dynamic max_len based on window width and session count
window_width=$(tmux display-message -p '#{window_width}' 2>/dev/null || echo 120)
other_modules_space=60  # approximate space for other status modules
session_count=$(head -4 "$file" | grep -c .)
session_count=${session_count:-1}

# Available space per session: (width - other_modules) / sessions - padding(3 chars)
available=$((window_width - other_modules_space))
max_len=$((available / session_count - 3))

# Clamp between 10 and 40
[ $max_len -lt 10 ] && max_len=10
[ $max_len -gt 40 ] && max_len=40

output=""
is_current_in_list=false
i=0

while IFS= read -r path && [ $i -lt 4 ]; do
    [ -z "$path" ] && continue
    name=$(basename "$path")

    # Truncate long names from the beginning
    if [ ${#name} -gt $max_len ]; then
        name="â€¦${name: -$((max_len-1))}"
    fi

    # Highlight if current session
    if [ "$path" = "$current_path" ]; then
        is_current_in_list=true
        output+="#[bg=$highlight_bg] $name #[bg=$normal_bg]"
    else
        output+=" $name "
    fi

    i=$((i + 1))
done < "$file"

echo "#[bg=default] #[bg=$normal_bg]${output%}"

