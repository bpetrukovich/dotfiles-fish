#!/usr/bin/env bash

# =========================
# CONFIG
# =========================

project_dirs=(
  "$HOME/personal"
  "$HOME/work"
)

extra_dirs=(
  "$HOME/obsidian-vault"
  "$HOME/docker-services/"
  "$HOME/.local/scripts"
  "$HOME/.local/share"
  "$HOME/.config/nvim"
  "$HOME/.config/fish"
  "$HOME/.config"
  "$HOME/.tmuxp"
  "$HOME/work/back"
  "$HOME/work/front"
  "$HOME/personal"
  "$HOME/work"
  "$HOME/buffer"
  "$HOME"
  "/mnt/c/Users/b.petrukovich/.config/wezterm"
)

CACHE_FILE="/tmp/tmux_dirs_cache"

# =========================
# DIR COLLECTION
# =========================

get_dirs() {
  {
    find "${project_dirs[@]}" \
      -mindepth 2 -maxdepth 2 \
      -type d \
      -not -path '*/.*' 2>/dev/null

    printf '%s\n' "${extra_dirs[@]}"
  }
}

get_dirs_with_zoxide() {
  local temp_file

  temp_file=$(mktemp)
  get_dirs > "$temp_file"

  while IFS= read -r dir; do
    [[ -z "$dir" ]] && continue
    local score
    score=$(zoxide query -s "$dir" 2>/dev/null | awk '{print $1}')
    printf "%s\t%s\n" "${score:-0}" "$dir"
  done < "$temp_file" | sort -rnk1 | cut -f2-

  rm -f "$temp_file"
}

# =========================
# PREVIEW
# =========================

create_preview_script() {
  cat <<'EOF'
#!/usr/bin/env bash
dir="$1"

[[ -z "$dir" || ! -d "$dir" ]] && exit 0

echo "=== $(basename "$dir") ==="
echo "Path: $dir"
echo

for file in "$dir"/README{,.md} "$dir"/readme{,.md}; do
  if [[ -f "$file" ]]; then
    echo "README: $(basename "$file")"
    echo "----------------------------------------"
    if command -v bat >/dev/null 2>&1; then
      bat --style=plain --color=always "$file" | head -30
    else
      head -30 "$file"
    fi
    exit 0
  fi
done

echo "No README"
echo "----------------------------------------"
ls -la "$dir" | head -15
EOF
}

# =========================
# CACHE
# =========================

update_cache() {
  if command -v zoxide >/dev/null 2>&1; then
    get_dirs_with_zoxide > "$CACHE_FILE"
  else
    get_dirs > "$CACHE_FILE"
  fi
}

# =========================
# TMUX HANDLING
# =========================

process_selected_dirs() {
  local selected_dirs="$1"
  local tmux_running
  tmux_running=$(pgrep tmux)

  local count
  count=$(echo "$selected_dirs" | wc -l)

  if [[ "$count" -eq 1 ]]; then
    local dir name
    dir="$selected_dirs"
    name=$(basename "$dir" | tr . _)

    zoxide add "$dir"

    tmux has-session -t="$name" 2>/dev/null \
      || tmux new-session -ds "$name" -c "$dir"

    if [[ -z "$TMUX" ]]; then
      tmux attach -t "$name"
    else
      tmux switch-client -t "$name"
      tmux refresh-client -S
    fi
    exit 0
  fi

  while IFS= read -r dir; do
    [[ -z "$dir" ]] && continue
    local name
    name=$(basename "$dir" | tr . _)

    zoxide add "$dir"
    tmux has-session -t="$name" 2>/dev/null \
      || tmux new-session -ds "$name" -c "$dir"
  done <<< "$selected_dirs"

  if [[ -z "$TMUX" && -z "$tmux_running" ]]; then
    local first
    first=$(basename "$(echo "$selected_dirs" | head -n1)" | tr . _)
    tmux attach -t "$first"
  elif [[ -n "$TMUX" ]]; then
    tmux choose-session
    tmux refresh-client -S
  else
    tmux attach
  fi
}

# =========================
# MAIN
# =========================

main() {
  # ---------- NON-INTERACTIVE MODE ----------
  if [[ $# -gt 0 ]]; then
    local resolved=()

    for arg in "$@"; do
      if [[ -d "$arg" ]]; then
        resolved+=("$(realpath "$arg")")
      else
        echo "Not a directory: $arg" >&2
        exit 1
      fi
    done

    process_selected_dirs "$(printf "%s\n" "${resolved[@]}")"
    exit 0
  fi

  # ---------- INTERACTIVE MODE ----------
  local preview_script
  preview_script=$(mktemp)
  create_preview_script > "$preview_script"
  chmod +x "$preview_script"

  if [[ ! -f "$CACHE_FILE" ]] || ! find "$CACHE_FILE" -mmin -30 >/dev/null 2>&1; then
    update_cache
  fi

  local selected
  selected=$(cat "$CACHE_FILE" | fzf \
    --multi \
    --prompt "Project > " \
    --preview "bash $preview_script {}" \
    --preview-window "right:60%:wrap" \
    --bind "ctrl-r:execute(rm -f $CACHE_FILE && $0 --update-cache && $0)+abort"
  )

  rm -f "$preview_script"

  [[ -z "$selected" ]] && exit 0
  process_selected_dirs "$selected"
}

# =========================
# ENTRYPOINT
# =========================

case "$1" in
  --update-cache|--generate-cache)
    update_cache
    ;;
  *)
    main "$@"
    ;;
esac
